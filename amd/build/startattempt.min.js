define(["jquery","core/ajax","core/notification"],(function(e,i,t){return{setup:function(n){window.invigilatorShareState=document.getElementById("invigilator_share_state"),window.invigilatorWindowSurface=document.getElementById("invigilator_window_surface"),window.invigilatorScreenoff=document.getElementById("invigilator_screen_off_flag");const r=document.getElementById("invigilator-video-screen"),a=document.getElementById("invigilator-log-screen"),o=n.screensharemsg,c=n.restartattemptcommand,s=n.somethingwentwrong;var d={monitorTypeSurfaces:"include",displaySurface:"monitor",video:{cursor:"always",mediaSource:"screen"},audio:!1};e("#invigilator-share-screen-btn").click((function(){!async function(){a.innerHTML="";try{r.srcObject=await navigator.mediaDevices.getDisplayMedia(d),e("#id_invigilator").css("display","block"),e("label[for='id_invigilator']").css("display","block")}catch(e){if("NotAllowedError: Permission denied"==e.toString())return t.addNotification({message:o,type:"error"}),!1}}()}));var l=setInterval((function(){if(null!==r.srcObject){const n=r.srcObject.getVideoTracks()[0];var e=r.srcObject,i=e.active,t=n.readyState;if(document.getElementById("invigilator_window_surface").value=t,document.getElementById("invigilator_share_state").value=i,"1"==document.getElementById("invigilator_screen_off_flag").value){e.getTracks().forEach((e=>e.stop())),clearInterval(l),location.reload()}}}),1e3),g=setInterval((function(){var e,a,d=document.getElementById("invigilator_screen_off_flag").value;if(null!==r.srcObject){const p=r.srcObject.getVideoTracks()[0];var l=r.srcObject.active,u=p.getSettings().displaySurface;if("0"==d){if(!l)return t.addNotification({message:c,type:"error"}),clearInterval(g),window.close(),!1;if("live"!==u)return t.addNotification({message:o,type:"error"}),clearInterval(g),window.close(),!1}var v=document.getElementById("invigilator-video-screen"),m=document.getElementById("invigilator-canvas-screen"),f=m.getContext("2d"),y=n.screenshotwidth,_=(e=n.screenshotwidth,a=screen.width/screen.height,e/a);m.width=y,m.height=_,f.drawImage(v,0,0,y,_);var w=m.toDataURL("image/png"),h={methodname:"quizaccess_invigilator_send_screenshot",args:{courseid:n.courseid,cmid:n.cmid,quizid:n.quizid,screenshot:w}};"0"==d&&i.call([h])[0].done((function(e){e.warnings.length<1||v&&(t.addNotification({message:s,type:"error"}),clearInterval(g))})).fail(t.exception)}return!0}),1e3*n.screenshotdelay)},init:function(i){e("#id_submitbutton").prop("disabled",!0),e("#id_invigilator").css("display","none"),e("label[for='id_invigilator']").css("display","none");const n=i.screensharemsg;return e("#id_invigilator").click((function(){if(e(this).is(":checked")){var i=document.getElementById("invigilator_share_state").value;"live"==document.getElementById("invigilator_window_surface").value&&"true"==i?e("#id_submitbutton").prop("disabled",!1):t.addNotification({message:n,type:"error"})}else e("#id_submitbutton").prop("disabled",!0)})),!0}}}));