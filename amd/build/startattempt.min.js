function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("quizaccess_invigilator/startattempt",["jquery","core/ajax","core/notification"],function(a,b,c){return{setup:function setup(d){window.invigilatorShareState=document.getElementById("invigilator_share_state");window.invigilatorWindowSurface=document.getElementById("invigilator_window_surface");window.invigilatorScreenoff=document.getElementById("invigilator_screen_off_flag");var h=document.getElementById("invigilator-video-screen"),i=document.getElementById("invigilator-log-screen"),j=d.screensharemsg,k=d.restartattemptcommand,l=d.somethingwentwrong,m={video:{cursor:"always"},audio:!1};a("#invigilator-share-screen-btn").click(function(){event.preventDefault();e()});function e(){return f.apply(this,arguments)}function f(){f=_asyncToGenerator(regeneratorRuntime.mark(function b(){var d;return regeneratorRuntime.wrap(function(b){while(1){switch(b.prev=b.next){case 0:i.innerHTML="";b.prev=1;b.next=4;return navigator.mediaDevices.getDisplayMedia(m);case 4:h.srcObject=b.sent;a("#id_invigilator").css("display","block");a("label[for='id_invigilator']").css("display","block");b.next=15;break;case 9:b.prev=9;b.t0=b["catch"](1);d=b.t0.toString();if(!("NotAllowedError: Permission denied"==d)){b.next=15;break}c.addNotification({message:j,type:"error"});return b.abrupt("return",!1);case 15:return b.abrupt("return",!0);case 16:case"end":return b.stop();}}},b,null,[[1,9]])}));return f.apply(this,arguments)}function g(a){var b=screen.width/screen.height;return a/b}var n=setInterval(function updateWindowStatus(){if(null!==h.srcObject){var a=h.srcObject.getVideoTracks()[0],b=h.srcObject,c=b.active,d=a.getSettings(),e=d.displaySurface;document.getElementById("invigilator_window_surface").value=e;document.getElementById("invigilator_share_state").value=c;var f=document.getElementById("invigilator_screen_off_flag").value;if("1"==f){a.stop();clearInterval(n);location.reload()}}},1e3),o=setInterval(function takeScreenshot(){var a=document.getElementById("invigilator_screen_off_flag").value;if(null!==h.srcObject){var e=h.srcObject.getVideoTracks()[0],f=h.srcObject,i=f.active,m=e.getSettings(),n=m.displaySurface;if("0"==a){if(!i){c.addNotification({message:k,type:"error"});clearInterval(o);window.close();return!1}if("monitor"!==n){c.addNotification({message:j,type:"error"});clearInterval(o);window.close();return!1}}var p=document.getElementById("invigilator-video-screen"),q=document.getElementById("invigilator-canvas-screen"),r=q.getContext("2d"),s=d.screenshotwidth,t=g(d.screenshotwidth);q.width=s;q.height=t;r.drawImage(p,0,0,s,t);var u=q.toDataURL("image/png"),v={courseid:d.courseid,cmid:d.cmid,quizid:d.quizid,screenshot:u};if("0"==a){b.call([{methodname:"quizaccess_invigilator_send_screenshot",args:v}])[0].done(function(a){if(!(1>a.warnings.length)){if(p){c.addNotification({message:l,type:"error"});clearInterval(o)}}}).fail(c.exception)}}return!0},1e3*d.screenshotdelay)},init:function init(b){a("#id_submitbutton").prop("disabled",!0);a("#id_invigilator").css("display","none");a("label[for='id_invigilator']").css("display","none");var f=b.screensharemsg;a("#id_invigilator").click(function(){if(!a(this).is(":checked")){d()}else{var b=document.getElementById("invigilator_share_state").value,g=document.getElementById("invigilator_window_surface").value;if("monitor"==g&&"true"==b){e()}else{c.addNotification({message:f,type:"error"})}}});function d(){a("#id_submitbutton").prop("disabled",!0)}function e(){a("#id_submitbutton").prop("disabled",!1)}return!0}}});
//# sourceMappingURL=startattempt.min.js.map
