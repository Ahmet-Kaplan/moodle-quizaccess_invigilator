define(["jquery","core/ajax","core/notification"],(function(e,i,t){return{setup:function(n){window.invigilatorShareState=document.getElementById("invigilator_share_state"),window.invigilatorWindowSurface=document.getElementById("invigilator_window_surface"),window.invigilatorScreenoff=document.getElementById("invigilator_screen_off_flag");const o=document.getElementById("invigilator-video-screen"),r=document.getElementById("invigilator-log-screen"),a=n.screensharemsg,c=n.restartattemptcommand,s=n.somethingwentwrong;var l={monitorTypeSurfaces:"include",displaySurface:"monitor",video:{cursor:"always",mediaSource:"screen"},audio:!1};e("#invigilator-share-screen-btn").click((function(){!async function(){r.innerHTML="";try{Console.log("vid found success"),o.srcObject=await navigator.mediaDevices.getDisplayMedia(l),Console.log("videoElem.srcObject",o.srcObject),e("#id_invigilator").css("display","block"),e("label[for='id_invigilator']").css("display","block")}catch(e){if(Console.log("Error: "+e.toString()),"NotAllowedError: Permission denied"==e.toString())return t.addNotification({message:a,type:"error"}),!1}}()}));var d=setInterval((function(){if(null!==o.srcObject){Console.log(o);const n=o.srcObject.getVideoTracks()[0];var e=o.srcObject,i=e.active,t=n.getSettings().displaySurface;if(Console.log("displaySurface - updateWindow : ",t),document.getElementById("invigilator_window_surface").value=t,document.getElementById("invigilator_share_state").value=i,"1"==document.getElementById("invigilator_screen_off_flag").value){e.getTracks().forEach((e=>e.stop())),clearInterval(d),location.reload()}}}),1e3),g=setInterval((function(){var e,r,l=document.getElementById("invigilator_screen_off_flag").value;if(null!==o.srcObject){const h=o.srcObject.getVideoTracks()[0];var d=o.srcObject.active,u=h.getSettings().displaySurface;if("0"==l){if(!d)return t.addNotification({message:c,type:"error"}),clearInterval(g),window.close(),!1;if(Console.log("displaySurface",u),"monitor"!==u)return t.addNotification({message:a,type:"error"}),clearInterval(g),window.close(),!1}var m=document.getElementById("invigilator-video-screen"),v=document.getElementById("invigilator-canvas-screen"),f=v.getContext("2d"),y=n.screenshotwidth,_=(e=n.screenshotwidth,r=screen.width/screen.height,e/r);v.width=y,v.height=_,f.drawImage(m,0,0,y,_);var w=v.toDataURL("image/png"),p={methodname:"quizaccess_invigilator_send_screenshot",args:{courseid:n.courseid,cmid:n.cmid,quizid:n.quizid,screenshot:w}};"0"==l&&i.call([p])[0].done((function(e){e.warnings.length<1||m&&(t.addNotification({message:s,type:"error"}),clearInterval(g))})).fail(t.exception)}return!0}),1e3*n.screenshotdelay)},init:function(i){e("#id_submitbutton").prop("disabled",!0),e("#id_invigilator").css("display","none"),e("label[for='id_invigilator']").css("display","none");const n=i.screensharemsg;return e("#id_invigilator").click((function(){if(e(this).is(":checked")){var i=document.getElementById("invigilator_share_state").value;"monitor"==document.getElementById("invigilator_window_surface").value&&"true"==i?e("#id_submitbutton").prop("disabled",!1):t.addNotification({message:n,type:"error"})}else e("#id_submitbutton").prop("disabled",!0)})),!0}}}));