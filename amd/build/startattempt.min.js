define(["jquery","core/ajax","core/notification"],(function(e,i,t){return{setup:function(n){window.invigilatorShareState=document.getElementById("invigilator_share_state"),window.invigilatorWindowSurface=document.getElementById("invigilator_window_surface"),window.invigilatorScreenoff=document.getElementById("invigilator_screen_off_flag");const r=document.getElementById("invigilator-video-screen"),o=document.getElementById("invigilator-log-screen"),a=n.screensharemsg,c=n.restartattemptcommand,s=n.somethingwentwrong;var d={monitorTypeSurfaces:"include",displaySurface:"monitor",video:{cursor:"always"},audio:!1};e("#invigilator-share-screen-btn").click((function(){!async function(){o.innerHTML="";try{r.srcObject=await navigator.mediaDevices.getDisplayMedia(d),e("#id_invigilator").css("display","block"),e("label[for='id_invigilator']").css("display","block")}catch(e){if(Console.log("Error: "+e.toString()),"NotAllowedError: Permission denied"==e.toString())return t.addNotification({message:a,type:"error"}),!1}}()}));var l=setInterval((function(){if(null!==r.srcObject){const t=r.srcObject.getVideoTracks()[0];var e=r.srcObject.active,i=t.getSettings().displaySurface;document.getElementById("invigilator_window_surface").value=i,document.getElementById("invigilator_share_state").value=e,"1"==document.getElementById("invigilator_screen_off_flag").value&&(t.stop(),clearInterval(l),location.reload())}}),1e3),g=setInterval((function(){var e,o,d=document.getElementById("invigilator_screen_off_flag").value;if(null!==r.srcObject){const p=r.srcObject.getVideoTracks()[0];var l=r.srcObject.active,u=p.getSettings().displaySurface;if("0"==d){if(!l)return t.addNotification({message:c,type:"error"}),clearInterval(g),window.close(),!1;if("monitor"!==u)return t.addNotification({message:a,type:"error"}),clearInterval(g),window.close(),!1}var m=document.getElementById("invigilator-video-screen"),v=document.getElementById("invigilator-canvas-screen"),f=v.getContext("2d"),y=n.screenshotwidth,_=(e=n.screenshotwidth,o=screen.width/screen.height,e/o);v.width=y,v.height=_,f.drawImage(m,0,0,y,_);var w=v.toDataURL("image/png"),h={methodname:"quizaccess_invigilator_send_screenshot",args:{courseid:n.courseid,cmid:n.cmid,quizid:n.quizid,screenshot:w}};"0"==d&&i.call([h])[0].done((function(e){e.warnings.length<1||m&&(t.addNotification({message:s,type:"error"}),clearInterval(g))})).fail(t.exception)}return!0}),1e3*n.screenshotdelay)},init:function(i){e("#id_submitbutton").prop("disabled",!0),e("#id_invigilator").css("display","none"),e("label[for='id_invigilator']").css("display","none");const n=i.screensharemsg;return e("#id_invigilator").click((function(){if(e(this).is(":checked")){var i=document.getElementById("invigilator_share_state").value;"monitor"==document.getElementById("invigilator_window_surface").value&&"true"==i?e("#id_submitbutton").prop("disabled",!1):t.addNotification({message:n,type:"error"})}else e("#id_submitbutton").prop("disabled",!0)})),!0}}}));